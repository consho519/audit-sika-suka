<script>
// ==========================================
// 1. GLOBAL STATE & INIT
// ==========================================
let currentUser = JSON.parse(localStorage.getItem('audit_user'));
let currentCabang = localStorage.getItem('audit_cabang') || "";
let selectedLokasi = null;
let selectedItems = new Set(); // Menyimpan item yang dicentang {idTrx, code}

// INIT
window.onload = function() {
    if(currentUser) {
        if(document.getElementById('login-wrapper')) document.getElementById('login-wrapper').remove();
        initApp();
    }
};

function initApp() {
    const app = document.getElementById('app-container');
    app.classList.remove('hidden');
    setTimeout(() => app.classList.remove('opacity-0'), 50);

    currentUser = JSON.parse(localStorage.getItem('audit_user'));
    document.getElementById('user-display-name').innerText = currentUser.username;
    document.getElementById('user-display-role').innerText = currentUser.role;

    loadDaftarCabang();
    navigasi('halaman-dashboard');
    
    // FIX RESPONSIVE: Paksa Bulk Bar jadi Fixed agar ikut scroll di HP
    const bulkBar = document.getElementById('bulk-action-bar');
    if(bulkBar) {
        bulkBar.classList.remove('absolute');
        bulkBar.classList.add('fixed');
    }

    // OTOMATIS BUKA MENU "DATA TEMUAN" SAAT START
    // Agar user langsung melihat menu di dalamnya tanpa perlu klik dulu
    bukaMenuAwal();
}

function doLogout() {
    if(confirm('Yakin ingin keluar?')) { localStorage.clear(); location.reload(); }
}

// ==========================================
// 2. NAVIGASI & SIDEBAR (UPDATED)
// ==========================================

function navigasi(id) {
    // Sembunyikan semua halaman
    document.querySelectorAll('.halaman').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    
    // Refresh data dashboard atau laporan
    if(id === 'halaman-dashboard') refreshDashboard();
    if(id.includes('laporan')) { 
        resetFilter('VALID'); resetFilter('NA');
        clearSelection();
        loadLaporan('VALID'); loadLaporan('NA'); 
    }
    
    // Sembunyikan Bulk Bar saat pindah halaman
    document.getElementById('bulk-action-bar').classList.add('hidden');

    // RESPONSIVE: Tutup sidebar mobile otomatis jika link diklik
    const mobileSidebar = document.getElementById('mobile-sidebar');
    if(mobileSidebar && !mobileSidebar.classList.contains('-translate-x-full')) {
        toggleSidebar();
    }
}

function toggleSidebar() {
    const s = document.getElementById('mobile-sidebar');
    const b = document.getElementById('mobile-sidebar-backdrop');
    s.classList.toggle('-translate-x-full'); 
    b.classList.toggle('hidden');
}

function toggleDesktopSidebar() {
    const s = document.getElementById('desktop-sidebar');
    // Logika Shrink/Expand Sidebar Desktop
    if (s.classList.contains('w-64')) {
        s.classList.remove('w-64');
        s.classList.add('w-0');
        s.classList.add('opacity-0'); 
    } else {
        s.classList.remove('w-0');
        s.classList.remove('opacity-0');
        s.classList.add('w-64');
    }
}

/**
 * Fungsi Baru: Mengatur Buka/Tutup Sub-Menu (Dropdown)
 * @param {string} menuId - ID div container sub-menu
 * @param {string} arrowId - ID icon panah
 */
function toggleSubmenu(menuId, arrowId) {
    const menu = document.getElementById(menuId);
    const arrow = document.getElementById(arrowId);
    
    if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden'); // Buka
        arrow.classList.add('rotate-180'); // Panah putar ke atas
    } else {
        menu.classList.add('hidden'); // Tutup
        arrow.classList.remove('rotate-180'); // Panah putar ke bawah
    }
}

/**
 * Fungsi Baru: Membuka menu "DATA TEMUAN" secara otomatis saat aplikasi dimuat
 */
function bukaMenuAwal() {
    // Daftar ID menu dan panah yang ingin dibuka default
    const ids = [
        {m: 'sub-desktop-temuan', a: 'arrow-desktop-temuan'},
        {m: 'sub-mobile-temuan', a: 'arrow-mobile-temuan'}
    ];
    
    ids.forEach(item => {
        const menu = document.getElementById(item.m);
        const arrow = document.getElementById(item.a);
        if(menu && arrow) {
            menu.classList.remove('hidden');
            arrow.classList.add('rotate-180');
        }
    });
}

// ==========================================
// 3. LOGIKA CABANG
// ==========================================
function loadDaftarCabang() {
    google.script.run.withSuccessHandler(res => {
        const sel = document.getElementById('pilih-cabang');
        sel.innerHTML = '<option value="" disabled selected>Pilih Cabang...</option>';
        res.list.forEach(c => {
            let opt = document.createElement('option'); opt.value = c; opt.innerText = c; sel.appendChild(opt);
        });
        if(currentCabang && res.list.includes(currentCabang)) { sel.value = currentCabang; updateUIBranch(); }
    }).getDaftarCabang(currentUser.username);
}

function gantiCabang(val) {
    currentCabang = val;
    localStorage.setItem('audit_cabang', val);
    updateUIBranch();
    showToast("Cabang aktif: " + val);
    refreshDashboard();
}

function updateUIBranch() {
    document.getElementById('dash-cabang-info').innerText = currentCabang;
}

// ==========================================
// 4. INPUT & SCAN OPERASIONAL
// ==========================================
function handleEnter(e) { if(e.key === 'Enter') cariBarang(); }

function cariBarang() {
    if(!currentCabang) return showToast("Pilih Cabang dulu!");
    const dpack = document.getElementById('input-dpack').value;
    if(!dpack) return;

    document.getElementById('loading-cari').classList.remove('hidden');
    document.getElementById('area-detail').classList.add('hidden');
    document.getElementById('area-input-qty').classList.add('hidden');
    document.getElementById('input-dpack').disabled = true;
    selectedLokasi = null;

    google.script.run.withSuccessHandler(res => {
        document.getElementById('loading-cari').classList.add('hidden');
        document.getElementById('area-detail').classList.remove('hidden');
        document.getElementById('area-input-qty').classList.remove('hidden');
        
        const cont = document.getElementById('lokasi-container');
        const badge = document.getElementById('badge-status');
        cont.innerHTML = '';

        if(res.found) {
            document.getElementById('hasil-part-number').innerText = res.partNumber;
            document.getElementById('status-barang').value = 'VALID';
            badge.innerText = "VALID";
            badge.className = "text-xs font-bold px-2 py-1 bg-green-100 text-green-700 rounded";
            
            res.items.forEach(item => {
                let div = document.createElement('div');
                div.className = "p-3 border rounded cursor-pointer hover:bg-blue-50 flex justify-between lokasi-item";
                div.innerHTML = `<div><div class='text-xs text-gray-400'>Lokasi</div><div class='font-bold'>${item.lokasi}</div></div><div class='text-right'><div class='text-xs text-gray-400'>Stok</div><div class='font-bold text-blue-600'>${item.stockSistem}</div></div>`;
                div.onclick = function() { pilihLokasi(item.lokasi, this); };
                cont.appendChild(div);
            });
            if(res.items.length > 0) pilihLokasi(res.items[0].lokasi, cont.firstChild);
        } else {
            document.getElementById('hasil-part-number').innerText = "Tidak Dikenal";
            document.getElementById('status-barang').value = 'NA';
            badge.innerText = "N/A";
            badge.className = "text-xs font-bold px-2 py-1 bg-red-100 text-red-700 rounded";
            cont.innerHTML = "<div class='text-red-500 text-sm'>Barang tidak ada di Master</div>";
            selectedLokasi = "UNKNOWN";
        }
        const iQty = document.getElementById('input-qty');
        iQty.value = 1; iQty.focus(); iQty.select();
    }).cariBarangDiMaster(dpack, currentCabang);
}

function pilihLokasi(loc, el) {
    selectedLokasi = loc;
    document.querySelectorAll('.lokasi-item').forEach(x => x.classList.remove('bg-blue-100', 'border-blue-500'));
    el.classList.add('bg-blue-100', 'border-blue-500');
}

function ubahQty(n) {
    let el = document.getElementById('input-qty');
    let v = parseInt(el.value) || 0;
    if(v + n > 0) el.value = v + n;
}

function resetForm() {
    const d = document.getElementById('input-dpack');
    d.value = ''; d.disabled = false; d.focus();
    document.getElementById('area-detail').classList.add('hidden');
    document.getElementById('area-input-qty').classList.add('hidden');
}

function simpanTemuan() {
    const trx = document.getElementById('input-id-trx').value;
    if(!trx) return showToast("Isi ID Transaksi!");
    
    const status = document.getElementById('status-barang').value;
    if(status === 'VALID' && !selectedLokasi) return showToast("Pilih Lokasi!");

    const btn = document.getElementById('btn-simpan');
    const txt = btn.innerText;
    btn.disabled = true; btn.innerText = "Simpan...";

    const data = {
        cabang: currentCabang,
        idTransaksi: trx,
        partDpack: document.getElementById('input-dpack').value,
        qty: document.getElementById('input-qty').value,
        status: status,
        partNumber: document.getElementById('hasil-part-number').innerText,
        lokasiSeharusnya: selectedLokasi
    };

    google.script.run.withSuccessHandler(res => {
        btn.disabled = false; btn.innerText = txt;
        if(res.success) { showToast("Tersimpan!"); resetForm(); }
        else { showToast("Gagal: " + res.message); }
    }).simpanDataTemuan(data);
}

// ==========================================
// 5. LAPORAN & DASHBOARD
// ==========================================

function refreshDashboard() {
    if(!currentCabang) return;
    google.script.run.withSuccessHandler(d => {
        document.getElementById('dash-total-qty').innerText = d.totalQty;
        document.getElementById('dash-valid-sku').innerText = d.validSKU;
        document.getElementById('dash-na-sku').innerText = d.naSKU;
        document.getElementById('dash-valid-qty-detail').innerText = d.validQty + " Pcs";
        document.getElementById('dash-na-qty-detail').innerText = d.naQty + " Pcs";
        const list = document.getElementById('dash-activity-list');
        list.innerHTML = '';
        d.recent.forEach(r => {
            let color = r.type==='VALID' ? 'text-gray-600' : 'text-red-500';
            list.innerHTML += `<tr class='border-b'><td class='p-3 ${color}'>${r.dpack}</td><td class='p-3 text-right font-bold'>${r.qty}</td><td class='p-3 text-right text-xs text-gray-400'>${new Date(r.time).toLocaleTimeString()}</td></tr>`;
        });
    }).getDashboardStats(currentCabang);
}

function loadLaporan(type) {
    if(!currentCabang) return;
    const tbody = document.getElementById(type==='VALID' ? 'tbody-valid' : 'tbody-na');
    const colSpan = type==='VALID' ? 8 : 6; // 8 kolom karena ada Checkbox
    
    tbody.innerHTML = `<tr><td colspan='${colSpan}' class='p-8 text-center text-gray-400'>Loading...</td></tr>`;
    
    google.script.run.withSuccessHandler(rows => {
        tbody.innerHTML = '';
        if(rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan='${colSpan}' class='p-8 text-center text-gray-400 italic'>Kosong</td></tr>`;
            return;
        }
        
        rows.forEach(r => {
            // Buat unique key untuk checkbox (ID|Code)
            let uniqueKey = `${r[1]}|${r[2]}`;
            
            let html = `<tr class='border-b hover:bg-gray-50 group transition row-data'>
                <!-- Checkbox untuk Bulk Action -->
                <td class='p-3 text-center no-print'>
                    <input type="checkbox" class="row-check rounded w-4 h-4 accent-blue-600 cursor-pointer" value="${uniqueKey}" onchange="handleCheck('${type}')">
                </td>`;
            
            if(type === 'VALID') {
                // r[1]=ID, r[2]=Code, r[3]=Qty, r[4]=Name, r[5]=Loc, r[6]=Time
                html += `
                    <td class='p-3 font-mono text-xs text-gray-500'>${r[1]}</td>
                    <td class='p-3 font-bold'>${r[2]}</td>
                    <td class='p-3 font-bold text-blue-600 text-center bg-blue-50/50 rounded'>${r[3]}</td>
                    <td class='p-3 text-sm'>${r[4]}</td>
                    <td class='p-3 text-xs bg-yellow-50'>${r[5]}</td>
                    <td class='p-3 text-[10px] text-gray-400 font-mono'>${new Date(r[6]).toLocaleString()}</td>
                    <!-- Kolom Aksi: Edit & Hapus -->
                    <td class='p-3 text-center no-print flex justify-center gap-1'>
                         <button onclick="bukaEdit('${r[2]}','${r[3]}','VALID','${r[1]}')" class="text-blue-400 hover:bg-blue-50 p-1.5 rounded transition" title="Edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                         <button onclick="hapusItem('${r[2]}','VALID','${r[1]}')" class="text-red-400 hover:bg-red-50 p-1.5 rounded transition" title="Hapus"><i class="ph ph-trash text-lg"></i></button>
                    </td>`;
            } else {
                // r[1]=ID, r[2]=Code, r[3]=Qty, r[4]=Time
                html += `
                    <td class='p-3 font-mono text-xs text-gray-500'>${r[1]}</td>
                    <td class='p-3 font-bold text-red-600'>${r[2]}</td>
                    <td class='p-3 font-bold text-center bg-red-50/50 rounded'>${r[3]}</td>
                    <td class='p-3 text-[10px] text-gray-400 font-mono'>${new Date(r[4]).toLocaleString()}</td>
                    <!-- Kolom Aksi: Edit & Hapus -->
                    <td class='p-3 text-center no-print flex justify-center gap-1'>
                         <button onclick="bukaEdit('${r[2]}','${r[3]}','NA','${r[1]}')" class="text-blue-400 hover:bg-blue-50 p-1.5 rounded transition" title="Edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                         <button onclick="hapusItem('${r[2]}','NA','${r[1]}')" class="text-red-400 hover:bg-red-50 p-1.5 rounded transition" title="Hapus"><i class="ph ph-trash text-lg"></i></button>
                    </td>`;
            }
            html += `</tr>`;
            tbody.innerHTML += html;
        });
    }).getLaporanData(type, currentCabang);
}

// ==========================================
// 6. SINGLE EDIT & DELETE
// ==========================================

function hapusItem(dpack, type, idTrx) {
    if(confirm('Hapus data ini permanen?')) {
        google.script.run.withSuccessHandler(r=>{
            if(r.success) { showToast("Terhapus"); loadLaporan(type); refreshDashboard(); }
            else { showToast("Gagal Hapus"); }
        }).hapusItem(dpack, type, currentCabang, idTrx);
    }
}

function bukaEdit(dpack, qty, type, idTrx) {
    document.getElementById('modal-edit').classList.remove('hidden');
    document.getElementById('display-edit-code').innerText = dpack;
    document.getElementById('edit-dpack').value = dpack;
    document.getElementById('edit-qty').value = qty;
    document.getElementById('edit-type').value = type;
    document.getElementById('edit-idtrx').value = idTrx;
    setTimeout(() => document.getElementById('edit-qty').select(), 100);
}

function tutupModalEdit() { document.getElementById('modal-edit').classList.add('hidden'); }

function prosesSimpanEdit() {
    let d = document.getElementById('edit-dpack').value;
    let q = document.getElementById('edit-qty').value;
    let t = document.getElementById('edit-type').value;
    let i = document.getElementById('edit-idtrx').value;
    
    tutupModalEdit();
    
    google.script.run.withSuccessHandler(r => {
        if(r.success) { showToast("Update Berhasil"); loadLaporan(t); refreshDashboard(); }
        else { showToast("Gagal Update: " + r.message, "error"); }
    }).editItem(d, q, t, currentCabang, i);
}

// ==========================================
// 7. FILTER & SELECTION LOGIC
// ==========================================

function applyFilter(type) {
    const txt = document.getElementById('search-'+type.toLowerCase()).value.toLowerCase();
    const dateVal = document.getElementById('date-'+type.toLowerCase()).value;
    const table = document.getElementById('table-'+type.toLowerCase());
    const rows = table.getElementsByTagName('tr');

    for(let i=1; i<rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        if(cells.length < 3) continue;

        let textMatch = false;
        let dateMatch = true;

        let rowText = "";
        for(let j=1; j<cells.length-1; j++) rowText += cells[j].innerText.toLowerCase() + " ";
        
        if(rowText.includes(txt)) textMatch = true;

        if(dateVal) {
            let dateIdx = type === 'VALID' ? 6 : 4;
            let rowDateStr = cells[dateIdx].innerText; 
            let dObj = new Date(rowDateStr);
            if(!isNaN(dObj.getTime())) {
                let y = dObj.getFullYear();
                let m = String(dObj.getMonth()+1).padStart(2,'0');
                let d = String(dObj.getDate()).padStart(2,'0');
                let isoDate = `${y}-${m}-${d}`;
                
                if(isoDate !== dateVal) dateMatch = false;
            }
        }

        rows[i].style.display = (textMatch && dateMatch) ? "" : "none";
    }
    
    handleCheck(type);
}

function resetFilter(type) {
    document.getElementById('search-'+type.toLowerCase()).value = "";
    document.getElementById('date-'+type.toLowerCase()).value = "";
    applyFilter(type);
}

// Checkbox Logic
function toggleSelectAll(type, el) {
    const table = document.getElementById('table-'+type.toLowerCase());
    const checkboxes = table.querySelectorAll('.row-check');
    checkboxes.forEach(cb => {
        if(cb.closest('tr').style.display !== 'none') {
            cb.checked = el.checked;
        }
    });
    handleCheck(type);
}

function handleCheck(type) {
    selectedItems.clear();
    const activeTab = !document.getElementById('halaman-laporan-valid').classList.contains('hidden') ? 'VALID' : 'NA';
    if(type !== activeTab) return;

    const table = document.getElementById('table-'+type.toLowerCase());
    const checkboxes = table.querySelectorAll('.row-check:checked');
    
    checkboxes.forEach(cb => {
        let val = cb.value.split('|'); // ID|Code
        selectedItems.add({idTrx: val[0], code: val[1]});
    });

    const bar = document.getElementById('bulk-action-bar');
    if(selectedItems.size > 0) {
        bar.classList.remove('hidden');
        document.getElementById('selected-count').innerText = selectedItems.size;
    } else {
        bar.classList.add('hidden');
    }
}

function clearSelection() {
    document.querySelectorAll('.row-check').forEach(cb => cb.checked = false);
    selectedItems.clear();
    document.getElementById('bulk-action-bar').classList.add('hidden');
}

// Bulk Actions
function bulkDelete() {
    if(!confirm(`Hapus ${selectedItems.size} item terpilih?`)) return;
    
    const type = !document.getElementById('halaman-laporan-valid').classList.contains('hidden') ? 'VALID' : 'NA';
    const items = Array.from(selectedItems); 

    google.script.run.withSuccessHandler(r => {
        if(r.success) {
            showToast(r.message, "success");
            clearSelection();
            loadLaporan(type);
            refreshDashboard();
        } else {
            showToast(r.message, "error");
        }
    }).prosesBulkAction(currentCabang, type, 'DELETE', items, null);
}

function bulkEdit() {
    let newQty = prompt(`Masukkan Qty baru untuk ${selectedItems.size} item ini:`);
    if(newQty === null || newQty.trim() === "") return;
    
    const type = !document.getElementById('halaman-laporan-valid').classList.contains('hidden') ? 'VALID' : 'NA';
    const items = Array.from(selectedItems);

    google.script.run.withSuccessHandler(r => {
        if(r.success) {
            showToast(r.message, "success");
            clearSelection();
            loadLaporan(type);
            refreshDashboard();
        } else {
            showToast(r.message, "error");
        }
    }).prosesBulkAction(currentCabang, type, 'EDIT_QTY', items, {qty: newQty});
}

// ==========================================
// 8. PRINT & EXPORT (SMART)
// ==========================================

function printLaporan(tableId) {
    if(selectedItems.size > 0) {
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(r => {
            const cb = r.querySelector('.row-check');
            if(cb && !cb.checked) r.classList.add('hidden-print-temp');
        });
        window.print();
        rows.forEach(r => r.classList.remove('hidden-print-temp'));
    } else {
        window.print();
    }
}

function exportTableToExcel(tableId, filename) {
    const tableSelect = document.getElementById(tableId);
    const tableClone = tableSelect.cloneNode(true);
    const rows = tableClone.querySelectorAll('tr');
    
    for(let i=rows.length-1; i>=0; i--) {
        const r = rows[i];
        
        if(r.style.display === 'none') {
            r.remove(); continue;
        }
        
        if(selectedItems.size > 0 && i > 0) { 
             const originalRow = tableSelect.rows[i];
             const cb = originalRow.querySelector('.row-check');
             if(cb && !cb.checked) {
                 r.remove(); continue;
             }
        }

        const cells = r.querySelectorAll('th, td');
        if(cells.length > 0) {
            cells[cells.length-1].remove(); // Hapus Aksi
            cells[0].remove();              // Hapus Checkbox
        }
    }

    let tableHTML = tableClone.outerHTML.replace(/ /g, '%20');
    let downloadLink = document.createElement("a");
    document.body.appendChild(downloadLink);
    
    filename = filename + '.xls';
    let dataType = 'application/vnd.ms-excel';
    
    if(navigator.msSaveOrOpenBlob){
        var blob = new Blob(['\ufeff', tableHTML], { type: dataType });
        navigator.msSaveOrOpenBlob( blob, filename);
    } else {
        downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
        downloadLink.download = filename;
        downloadLink.click();
    }
    document.body.removeChild(downloadLink);
}

function showToast(msg, type = 'normal') {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.className = `fixed bottom-6 right-6 px-6 py-4 rounded-xl shadow-2xl z-50 text-white font-bold transition duration-300 translate-y-24 ${type==='error'?'bg-red-600':(type==='success'?'bg-green-600':'bg-gray-800')}`;
    requestAnimationFrame(() => t.classList.remove('translate-y-24'));
    setTimeout(() => t.classList.add('translate-y-24'), 3000);
}
</script>
